pipeline { agent any stages { stage('Build') { steps { sh 'docker build -t my-docker-image .' } } stage('Push to Docker Hub') { steps { withCredentials([usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'DOCKER_HUB_PASSWORD', usernameVariable: 'DOCKER_HUB_USERNAME')]) { sh 'echo $DOCKER_HUB_PASSWORD | docker login --username $DOCKER_HUB_USERNAME --password-stdin' sh 'docker tag my-docker-image:latest my-docker-image:$BUILD_NUMBER' sh 'docker push my-docker-image:latest' sh 'docker push my-docker-image:$BUILD_NUMBER' } } } stage('Deploy to AWS EC2') { steps { withCredentials([sshUserPrivateKey(credentialsId: 'ssh-key', keyFileVariable: 'SSH_KEY', passphraseVariable: '', usernameVariable: 'SSH_USERNAME')]) { sshagent(['ssh-key']) { sh 'ssh -o StrictHostKeyChecking=no $SSH_USERNAME@<EC2_INSTANCE_IP> "docker pull my-docker-image:$BUILD_NUMBER && docker stop my-container && docker rm my-container && docker run -d --name my-container -p 80:3000 my-docker-image:$BUILD_NUMBER"' } } } } } }
